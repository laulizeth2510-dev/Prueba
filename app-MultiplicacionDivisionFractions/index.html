<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Fraction Multiplication & Division Practice (K-5)</title>
    <!-- Load Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
      /* Custom styles for fraction display and vertical alignment */
      .fraction-display {
        display: inline-flex;
        flex-direction: column;
        align-items: center;
        justify-content: center;
        line-height: 1;
      }
      .fraction-bar {
        border-bottom: 2px solid currentColor;
        width: 100%;
        margin: 0 -0.25rem; /* Optical adjustment */
      }
      .numerator,
      .denominator {
        padding: 0 0.25rem;
        font-size: 2.5rem;
        font-weight: 700;
      }
      .operator {
        font-size: 3rem;
        font-weight: 300;
        padding: 0 0.75rem;
      }
      .feedback-input {
        border-left: 4px solid;
        padding-left: 0.75rem;
        transition: all 0.2s;
      }
      .correct {
        border-left-color: #10b981; /* Green 500 */
      }
      .incorrect {
        border-left-color: #ef4444; /* Red 500 */
      }
      .failed {
        border-left-color: #f97316; /* Orange 500 */
      }
    </style>
  </head>
  <body
    class="bg-gray-50 min-h-screen flex flex-col items-center p-4 font-sans"
  >
    <!-- Back to Home Button -->
    <a
      href="../index.html"
      style="
        position: fixed;
        top: 20px;
        left: 20px;
        background: white;
        color: #7b68ee;
        border: 3px solid #7b68ee;
        padding: 0.75rem 1.5rem;
        border-radius: 50px;
        font-weight: 600;
        text-decoration: none;
        display: inline-flex;
        align-items: center;
        gap: 0.5rem;
        box-shadow: 0 4px 16px rgba(123, 104, 238, 0.2);
        transition: all 0.3s ease;
        z-index: 1000;
      "
    >
      ‚Üê Men√∫ Principal
    </a>

    <div
      class="w-full max-w-3xl bg-white shadow-2xl rounded-2xl p-6 md:p-8 mt-8 border border-purple-200"
    >
      <h1 class="text-3xl font-extrabold text-purple-800 mb-2 text-center">
        Multiplication & Division Practice
      </h1>
      <p class="text-gray-500 mb-6 text-center text-lg">
        Solve the fraction equation below. Provide your answer as a simplified
        fraction.
      </p>

      <!-- Progress Bar -->
      <div class="mb-6">
        <div class="text-sm text-gray-600 mb-1 flex justify-between">
          <span>Problem <span id="currentProblemDisplay">1</span> of 20</span>
          <span id="scoreDisplay">Score: 0/0</span>
        </div>
        <div class="w-full bg-gray-200 rounded-full h-3">
          <div
            id="progressBar"
            class="bg-purple-600 h-3 rounded-full transition-all duration-500"
            style="width: 0%"
          ></div>
        </div>
      </div>

      <!-- Exercise Area -->
      <div
        class="flex flex-col items-center justify-center p-6 bg-purple-50 rounded-xl mb-6 shadow-inner min-h-[150px]"
      >
        <div id="problemDisplay" class="text-center flex items-center">
          <!-- Fraction problem generated here -->
          <p class="text-gray-500 text-xl">Loading problem...</p>
        </div>
      </div>

      <!-- Input and Check -->
      <div id="interactionArea" class="flex flex-col items-center space-y-4">
        <div class="text-xl font-bold text-gray-700">Your Answer:</div>

        <div class="flex items-center space-x-2">
          <input
            type="number"
            id="inputNum"
            placeholder="Numerator"
            class="w-28 p-3 text-center border-2 border-gray-300 rounded-lg focus:border-purple-500 focus:ring-purple-500 transition duration-150"
          />
          <span class="text-4xl text-gray-400">/</span>
          <input
            type="number"
            id="inputDen"
            placeholder="Denominator"
            class="w-28 p-3 text-center border-2 border-gray-300 rounded-lg focus:border-purple-500 focus:ring-purple-500 transition duration-150"
          />
        </div>

        <button
          onclick="checkAnswer()"
          id="checkButton"
          class="w-full max-w-xs bg-purple-500 hover:bg-purple-600 text-white font-extrabold py-3 rounded-xl transition duration-150 shadow-lg mt-4 uppercase tracking-wider disabled:bg-gray-400"
        >
          Check Answer
        </button>
      </div>

      <!-- Feedback and Next Problem -->
      <div id="feedbackArea" class="mt-6 p-4 rounded-xl hidden">
        <!-- Feedback message goes here -->
      </div>
    </div>

    <script>
      // --- Configuration ---
      const TOTAL_PROBLEMS = 20;
      const MAX_ATTEMPTS = 3;
      // Denominators can be slightly larger for M/D as common denominators are not needed.
      const DENOMINATORS = [2, 3, 4, 5, 6, 8, 10, 12];

      // --- State ---
      let state = {
        currentProblemIndex: 0, // 0 to 19 (for 20 problems)
        correctlySolved: 0,
        currentProblem: null, // Stores { fractions: [], answer: { num: 0, den: 0 } }
        attemptCounters: 0,
      };

      // --- Helper Functions (Math Logic) ---

      /** Calculates the Greatest Common Divisor (GCD) using the Euclidean algorithm. */
      const gcd = (a, b) => (b === 0 ? a : gcd(b, a % b));

      /** Simplifies a fraction to its lowest terms. */
      function simplifyFraction(num, den) {
        if (num === 0) return { num: 0, den: 1 };
        if (den === 0) return { num: 0, den: 0 };

        // Ensure the denominator is always positive
        const sign = (num < 0 && den < 0) || (num > 0 && den < 0) ? -1 : 1;

        num = Math.abs(num);
        den = Math.abs(den);

        const commonDivisor = gcd(num, den);
        return {
          num: sign * (num / commonDivisor),
          den: den / commonDivisor,
        };
      }

      // --- Problem Generation Logic ---

      /** Generates a single random fraction. */
      function generateSingleFraction() {
        const den =
          DENOMINATORS[Math.floor(Math.random() * DENOMINATORS.length)];
        // Keep numerator slightly larger to encourage simplification practice
        let num = Math.floor(Math.random() * (den * 2)) + 1;

        return { num, den };
      }

      /** Generates an array of 2, 3, or 4 fractions with random operators (* or /). */
      function generateProblem() {
        const numFractions = Math.floor(Math.random() * 3) + 2; // 2, 3, or 4 fractions
        let fractions = [];

        for (let i = 0; i < numFractions; i++) {
          const fraction = generateSingleFraction();
          // Assign operator for all except the first one
          const operators = ["*", "/"];
          fraction.op =
            i === 0
              ? "*"
              : operators[Math.floor(Math.random() * operators.length)];
          fractions.push(fraction);
        }

        // NOTE: For M/D, the result is always positive since we only use positive fractions.
        return fractions;
      }

      /** Calculates the simplified result of the multiplication and division problem. */
      function calculateAnswer(fractions) {
        if (fractions.length === 0) return { num: 0, den: 1 };

        let resultNum = fractions[0].num;
        let resultDen = fractions[0].den;

        // Iterate over the remaining fractions
        for (let i = 1; i < fractions.length; i++) {
          const f = fractions[i];

          if (f.op === "*") {
            // Multiplication: (A/B) * (C/D) = (A*C) / (B*D)
            resultNum *= f.num;
            resultDen *= f.den;
          } else if (f.op === "/") {
            // Division: (A/B) / (C/D) = (A/B) * (D/C)
            // Multiply by the reciprocal (flip numerator and denominator)
            resultNum *= f.den; // New numerator is A * D
            resultDen *= f.num; // New denominator is B * C
          }

          // Optional: Simplify intermediate results to prevent huge numbers
          // let simplified = simplifyFraction(resultNum, resultDen);
          // resultNum = simplified.num;
          // resultDen = simplified.den;
          // NOTE: Skipping intermediate simplification to keep the logic fast, but the final result MUST be simplified.
        }

        return simplifyFraction(resultNum, resultDen);
      }

      // --- Rendering Functions ---

      /** Renders the fraction problem on the screen. */
      function renderProblem(fractions) {
        const problemDisplay = document.getElementById("problemDisplay");
        problemDisplay.innerHTML = "";

        fractions.forEach((f, index) => {
          // Add operator if it's not the first fraction
          if (index > 0) {
            const opSpan = document.createElement("span");
            opSpan.className = "operator text-purple-600";
            opSpan.textContent = f.op === "*" ? "√ó" : "√∑"; // Use symbols for better visual clarity
            problemDisplay.appendChild(opSpan);
          }

          // Create fraction display structure
          const fractionDiv = document.createElement("div");
          fractionDiv.className = "fraction-display text-gray-800 mx-1";
          fractionDiv.innerHTML = `
                    <span class="numerator">${f.num}</span>
                    <span class="fraction-bar w-full"></span>
                    <span class="denominator">${f.den}</span>
                `;
          problemDisplay.appendChild(fractionDiv);
        });

        // Add equals sign
        const eqSpan = document.createElement("span");
        eqSpan.className = "operator text-purple-600";
        eqSpan.textContent = "=";
        problemDisplay.appendChild(eqSpan);
      }

      /** Renders the next problem in the sequence. */
      function nextProblem() {
        if (state.currentProblemIndex >= TOTAL_PROBLEMS) {
          // End of exercise
          document.getElementById("problemDisplay").innerHTML = `
                    <p class="text-3xl font-extrabold text-green-700">Exercise Complete!</p>
                    <p class="text-xl text-gray-700 mt-2">Final Score: ${state.correctlySolved} out of ${TOTAL_PROBLEMS}</p>
                `;
          document.getElementById("checkButton").disabled = true;
          document.getElementById("inputNum").disabled = true;
          document.getElementById("inputDen").disabled = true;
          return;
        }

        // Reset state for new problem
        state.attemptCounters = 0;

        // Clear inputs and feedback
        document.getElementById("inputNum").value = "";
        document.getElementById("inputDen").value = "";
        document.getElementById("checkButton").disabled = false;
        document.getElementById("inputNum").disabled = false;
        document.getElementById("inputDen").disabled = false;
        document.getElementById("feedbackArea").classList.add("hidden");

        // --- PROBLEM GENERATION ---
        const fractions = generateProblem();
        const answer = calculateAnswer(fractions);

        // Store and render the validated problem
        state.currentProblem = { fractions, answer };

        renderProblem(fractions);

        // Update display
        document.getElementById("currentProblemDisplay").textContent =
          state.currentProblemIndex + 1;
        updateProgress();
      }

      /** Updates the progress bar and score display. */
      function updateProgress() {
        const progress = (state.currentProblemIndex / TOTAL_PROBLEMS) * 100;
        document.getElementById("progressBar").style.width = `${progress}%`;
        document.getElementById(
          "scoreDisplay"
        ).textContent = `Score: ${state.correctlySolved}/${state.currentProblemIndex}`;
      }

      // --- Interaction Functions ---

      /** Handles the user submitting an answer. */
      function checkAnswer() {
        const inputNum = document.getElementById("inputNum");
        const inputDen = document.getElementById("inputDen");
        const feedbackArea = document.getElementById("feedbackArea");
        const checkButton = document.getElementById("checkButton");

        const userAnswerNum = parseInt(inputNum.value.trim(), 10);
        const userAnswerDen = parseInt(inputDen.value.trim(), 10);

        // 1. Input Validation
        if (
          isNaN(userAnswerNum) ||
          isNaN(userAnswerDen) ||
          userAnswerDen === 0
        ) {
          feedbackArea.textContent =
            "Please enter valid, non-zero numbers for the numerator and denominator.";
          feedbackArea.className =
            "mt-6 p-4 rounded-xl feedback-input incorrect";
          feedbackArea.classList.remove("hidden");
          return;
        }

        // 2. Simplification and Comparison
        const correct = state.currentProblem.answer;
        const userSimplified = simplifyFraction(userAnswerNum, userAnswerDen);

        const isCorrect =
          userSimplified.num === correct.num &&
          userSimplified.den === correct.den;

        if (isCorrect) {
          // CORRECT ANSWER
          state.correctlySolved++;
          state.currentProblemIndex++; // Move to next problem

          feedbackArea.innerHTML =
            "<strong>Correct!</strong> Well done! Moving to the next problem in 2 seconds... ‚úÖ";
          feedbackArea.className = "mt-6 p-4 rounded-xl feedback-input correct";
          feedbackArea.classList.remove("hidden");

          // Block input and wait for transition
          inputNum.disabled = true;
          inputDen.disabled = true;
          checkButton.disabled = true;

          setTimeout(nextProblem, 2000);
        } else {
          // INCORRECT ANSWER
          state.attemptCounters++;
          const attemptsLeft = MAX_ATTEMPTS - state.attemptCounters;

          if (attemptsLeft > 0) {
            // INCORRECT - Attempts Left
            feedbackArea.innerHTML = `<strong>Incorrect.</strong> Please try again. Attempts remaining: ${attemptsLeft}. ‚ùå`;
            feedbackArea.className =
              "mt-6 p-4 rounded-xl feedback-input incorrect";
          } else {
            // MAX ATTEMPTS REACHED - Reveal Answer
            state.currentProblemIndex++; // Move to next problem

            feedbackArea.innerHTML = `
                        <strong>Max attempts reached.</strong> The simplified answer is: 
                        <span class="text-2xl font-extrabold text-purple-800">${correct.num} / ${correct.den}</span>.
                        Moving to the next problem in 5 seconds... üò•
                    `;
            feedbackArea.className =
              "mt-6 p-4 rounded-xl feedback-input failed";

            // Block input and wait for transition
            inputNum.disabled = true;
            inputDen.disabled = true;
            checkButton.disabled = true;

            setTimeout(nextProblem, 5000);
          }
          feedbackArea.classList.remove("hidden");
        }
      }

      // --- Initialization ---

      window.onload = function () {
        // Start the first problem
        nextProblem();
      };
    </script>
  </body>
</html>
