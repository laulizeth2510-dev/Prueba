<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Powers & Exponents Challenge - Ages 10-16</title>
    <link rel="stylesheet" href="../shared-styles.css" />
    <style>
      /* Additional styles specific to this challenge */
      .quiz-option {
        font-family: var(--font-body);
        font-weight: 600;
        padding: 0.75rem 1.5rem;
        border-radius: 12px;
        border: 3px solid var(--border-color);
        background: white;
        cursor: pointer;
        transition: all 0.2s ease;
        font-size: 1.1rem;
      }

      .quiz-option:hover:not(:disabled) {
        transform: scale(1.1) rotate(-2deg);
        box-shadow: var(--shadow-md);
        border-color: var(--color-math-purple);
      }

      .selected-yes {
        background: linear-gradient(
          135deg,
          var(--color-math-green),
          #27ae60
        ) !important;
        color: white !important;
        border-color: var(--color-math-green) !important;
      }

      .selected-no {
        background: linear-gradient(
          135deg,
          var(--color-math-pink),
          #e91e63
        ) !important;
        color: white !important;
        border-color: var(--color-math-pink) !important;
      }

      .quiz-option:disabled {
        cursor: not-allowed;
        opacity: 0.7;
      }

      .quiz-item {
        background: white;
        border-radius: 15px;
        padding: 1rem 1.5rem;
        box-shadow: var(--shadow-sm);
        border: 2px solid var(--border-color);
        transition: all 0.3s ease;
      }

      .quiz-item:hover {
        transform: translateX(5px);
        box-shadow: var(--shadow-md);
      }

      .quiz-label {
        font-family: var(--font-handwriting);
        font-size: 1.3rem;
        color: var(--text-primary);
        display: flex;
        align-items: center;
        gap: 0.5rem;
      }

      .divisor-number {
        font-family: var(--font-heading);
        font-size: 2rem;
        color: var(--color-math-purple);
        font-weight: 700;
      }

      .feedback-item {
        border-radius: 15px;
        padding: 1.5rem;
        margin-bottom: 1rem;
        border-left: 6px solid;
        animation: slideIn 0.3s ease;
      }

      .feedback-correct {
        background: var(--bg-light-green);
        border-color: var(--color-math-green);
      }

      .feedback-incorrect {
        background: #ffebee;
        border-color: var(--color-math-pink);
      }

      .score-box {
        background: linear-gradient(
          135deg,
          var(--bg-light-blue),
          var(--bg-light-purple)
        );
        border: 4px solid var(--color-math-purple);
        border-radius: 20px;
        padding: 2rem;
        text-align: center;
        box-shadow: var(--shadow-lg);
      }

      .score-text {
        font-family: var(--font-heading);
        font-size: 2rem;
        color: var(--color-math-purple);
      }
    </style>
  </head>
  <body>
    <!-- Back to Home Button -->
    <a href="../index.html" class="btn-back-home"> Home Menu </a>

    <!-- Decorative Doodles -->
    <div class="doodle doodle-1">‚ö°</div>
    <div class="doodle doodle-2">üî¢</div>
    <div class="doodle doodle-3">‚ú®</div>
    <div class="doodle doodle-4">üìä</div>

    <div class="container">
      <!-- Header -->
      <header class="header">
        <h1>POWERS & EXPONENTS</h1>
        <p class="subtitle">Is this number a multiple of...? Discover it!</p>
      </header>

      <!-- Main Card -->
      <div class="card">
        <!-- Number Display -->
        <div class="problem-box">
          <p
            class="handwriting"
            style="
              font-size: 1.2rem;
              color: var(--text-secondary);
              margin-bottom: 0.5rem;
            "
          >
            Number to Analyze
          </p>
          <div id="randomNumberDisplay" class="problem-number">...</div>
        </div>

        <!-- Quiz Options -->
        <div
          id="quizOptions"
          style="
            display: flex;
            flex-direction: column;
            gap: 1rem;
            margin-bottom: 2rem;
          "
        >
          <!-- Las opciones del quiz se generar√°n aqu√≠ -->
        </div>

        <!-- Controls -->
        <div style="display: flex; gap: 1rem; margin-bottom: 2rem">
          <button
            onclick="generateNewNumber()"
            id="newNumberButton"
            class="btn btn-primary"
            style="flex: 1"
          >
            üé≤ New Number
          </button>
        </div>

        <!-- Feedback List -->
        <div id="feedbackListContainer" style="margin-top: 2rem">
          <!-- El feedback individual se insertar√° aqu√≠ -->
        </div>

        <!-- Final Score -->
        <div id="finalScoreContainer" style="margin-top: 2rem">
          <!-- El score final se insertar√° aqu√≠ -->
        </div>
      </div>
    </div>

    <script>
      // --- Variables de Estado del Quiz ---
      let currentNumber = 0;
      let checksData = []; // Almacena el resultado de getDivisibilityRules()
      let userAnswers = {}; // {2: null, 3: null, ...}
      const divisors = [2, 3, 5, 6, 7, 9, 10];

      // Referencias a elementos del DOM
      const randomNumberDisplay = document.getElementById(
        "randomNumberDisplay"
      );
      const quizOptionsContainer = document.getElementById("quizOptions");
      const feedbackListContainer = document.getElementById(
        "feedbackListContainer"
      );
      const finalScoreContainer = document.getElementById(
        "finalScoreContainer"
      );

      // Variables para el seguimiento del estado
      let answersCount = 0;
      let correctCount = 0;

      // --- Utilidades ---

      /**
       * Calcula la suma de los d√≠gitos de un n√∫mero (valor absoluto).
       */
      function getSumOfDigits(num) {
        return String(Math.abs(num))
          .split("")
          .map(Number)
          .reduce((sum, digit) => sum + digit, 0);
      }

      /**
       * Genera las reglas de divisibilidad y las respuestas correctas.
       */
      function getDivisibilityRules(num) {
        const absNumber = Math.abs(num);
        const sumOfDigits = getSumOfDigits(num);
        const lastDigit = absNumber % 10;

        return [
          {
            divisor: 2,
            isMultiple: absNumber % 2 === 0,
            rule: `The number ${absNumber} ends in ${lastDigit}. To be a multiple of 2, the last digit must be 0, 2, 4, 6, or 8.`,
            icon: "üî¢",
          },
          {
            divisor: 3,
            isMultiple: sumOfDigits % 3 === 0,
            rule: `The sum of its digits is ${sumOfDigits}. To be a multiple of 3, the sum of its digits (${sumOfDigits}) must be divisible by 3.`,
            icon: "‚ûï",
          },
          {
            divisor: 5,
            isMultiple: lastDigit === 0 || lastDigit === 5,
            rule: `The number ${absNumber} ends in ${lastDigit}. To be a multiple of 5, the last digit must be 0 or 5.`,
            icon: "‚úã",
          },
          {
            divisor: 6,
            isMultiple: absNumber % 2 === 0 && sumOfDigits % 3 === 0,
            rule: `It must be a multiple of 2 AND 3 at the same time. Check if the divisibility rules for 2 and 3 are satisfied.`,
            icon: "üîÑ",
          },
          {
            divisor: 7,
            isMultiple: absNumber % 7 === 0,
            rule: `The easiest way is to divide ${absNumber} by 7. Rule: Subtract double the last digit from the remaining number; the result must be divisible by 7.`,
            icon: "‚≠ê",
          },
          {
            divisor: 9,
            isMultiple: sumOfDigits % 9 === 0,
            rule: `The sum of its digits is ${sumOfDigits}. To be a multiple of 9, the sum of its digits (${sumOfDigits}) must be divisible by 9.`,
            icon: "‚ú®",
          },
          {
            divisor: 10,
            isMultiple: lastDigit === 0,
            rule: `The number ${absNumber} ends in ${lastDigit}. To be a multiple of 10, the last digit must be 0.`,
            icon: "üîü",
          },
        ];
      }

      // --- L√≥gica del Quiz ---

      /**
       * Renderiza la tarjeta de feedback individual para un divisor.
       * @param {number} divisor - El divisor comprobado.
       */
      function renderIndividualFeedback(divisor) {
        const check = checksData.find((c) => c.divisor === divisor);
        const userAnswer = userAnswers[divisor];
        const isCorrect = userAnswer === check.isMultiple;

        if (isCorrect) correctCount++;
        answersCount++;

        const colorClass = isCorrect
          ? "feedback-correct"
          : "feedback-incorrect";
        const resultText = isCorrect ? "Correct!" : "Incorrect!";
        const feedbackIcon = isCorrect ? "‚úÖ" : "‚ùå";
        const correctLabel = check.isMultiple
          ? "YES is a multiple"
          : "NO is not a multiple";

        const feedbackItem = document.createElement("div");
        feedbackItem.className = `feedback-item ${colorClass}`;
        feedbackItem.id = `feedback-${divisor}`;
        feedbackItem.innerHTML = `
            <div style="display: flex; align-items: center; justify-content: space-between; margin-bottom: 0.5rem;">
                <h3 style="font-family: var(--font-heading); font-size: 1.5rem; color: var(--text-primary); display: flex; align-items: center; gap: 0.5rem;">
                    ${feedbackIcon} Multiple of ${divisor}
                </h3>
                <span style="font-family: var(--font-body); font-weight: 700; font-size: 1.1rem; padding: 0.5rem 1rem; border-radius: 20px; ${
                  isCorrect
                    ? "background: var(--color-math-green); color: white;"
                    : "background: var(--color-math-pink); color: white;"
                }">
                    ${resultText}
                </span>
            </div>
            <p style="font-family: var(--font-handwriting); font-size: 1.1rem; margin-top: 0.5rem;">
                <span style="font-weight: 700;">Your Answer:</span> ${
                  userAnswer ? "YES" : "NO"
                }
                <span style="margin-left: 1rem; font-weight: 700;">Correct Answer:</span> ${correctLabel}
            </p>
            <p style="font-family: var(--font-body); margin-top: 0.75rem; padding-top: 0.75rem; border-top: 2px dashed var(--border-color);">
                <span style="font-weight: 600; color: var(--color-math-purple);">üí° Rule:</span> ${
                  check.rule
                }
            </p>
        `;
        feedbackListContainer.appendChild(feedbackItem);

        // Si todas las respuestas han sido dadas, mostrar el puntaje final
        if (answersCount === divisors.length) {
          displayFinalScore();
        }
      }

      /**
       * Muestra el resumen del puntaje final.
       */
      function displayFinalScore() {
        const totalChecks = divisors.length;
        const percentage = ((correctCount / totalChecks) * 100).toFixed(0);
        const scoreMessage = `Final Score: ${correctCount} out of ${totalChecks} (${percentage}%)`;

        let emoji = "üéâ";
        if (percentage >= 90) emoji = "üåü";
        else if (percentage >= 70) emoji = "üéâ";
        else if (percentage >= 50) emoji = "üëç";
        else emoji = "üí™";

        const scoreBox = document.createElement("div");
        scoreBox.className = "score-box";
        scoreBox.innerHTML = `
            <div style="font-size: 4rem; margin-bottom: 1rem;">${emoji}</div>
            <h2 class="score-text">${scoreMessage}</h2>
            <p class="handwriting" style="margin-top: 1rem; font-size: 1.2rem; color: var(--text-secondary);">
                ${
                  percentage >= 70
                    ? "Great job!"
                    : "Keep practicing!"
                }
            </p>
        `;

        finalScoreContainer.appendChild(scoreBox);
      }

      /**
       * Selecciona la respuesta del usuario, da feedback individual e inicia la comprobaci√≥n final si es necesario.
       * @param {number} divisor - El divisor al que se aplica la respuesta.
       * @param {boolean} answer - La respuesta del usuario (true = S√ç, false = NO).
       * @param {HTMLElement} btnYes - Bot√≥n S√ç.
       * @param {HTMLElement} btnNo - Bot√≥n NO.
       */
      function selectAnswer(divisor, answer, btnYes, btnNo) {
        // Si ya tiene una respuesta registrada (y los botones est√°n deshabilitados), no hacer nada
        if (userAnswers[divisor] !== null) return;

        userAnswers[divisor] = answer;

        // L√≥gica de selecci√≥n visual
        if (answer === true) {
          btnYes.classList.add("selected-yes");
        } else {
          btnNo.classList.add("selected-no");
        }

        // Deshabilitar botones para este criterio una vez respondido
        btnYes.disabled = true;
        btnNo.disabled = true;

        // Dar feedback inmediato
        renderIndividualFeedback(divisor);
      }

      /**
       * Genera un nuevo n√∫mero aleatorio y resetea el quiz.
       */
      function generateNewNumber() {
        // Generar un n√∫mero aleatorio entre 1 y 1000 (excluyendo el 0)
        currentNumber = Math.floor(Math.random() * 999) + 1;

        // Resetear estado y contadores
        userAnswers = {};
        answersCount = 0;
        correctCount = 0;
        feedbackListContainer.innerHTML = "";
        finalScoreContainer.innerHTML = "";

        // Actualizar la UI
        randomNumberDisplay.textContent = currentNumber;

        // Calcular y almacenar las reglas y respuestas correctas
        checksData = getDivisibilityRules(currentNumber);
        renderQuizOptions(checksData);
      }

      /**
       * Renderiza los botones de S√ç/NO para cada divisor.
       * @param {Array} checks - Lista de divisores y reglas.
       */
      function renderQuizOptions(checks) {
        quizOptionsContainer.innerHTML = "";

        checks.forEach((check) => {
          const divisor = check.divisor;

          // Inicializar respuesta del usuario
          userAnswers[divisor] = null;

          const optionDiv = document.createElement("div");
          optionDiv.className = "quiz-item";

          optionDiv.innerHTML = `
                <div style="display: flex; align-items: center; justify-content: space-between;">
                    <span class="quiz-label">
                        ${check.icon} Is it a multiple of <span class="divisor-number">${divisor}</span>?
                    </span>
                    <div style="display: flex; gap: 0.75rem;">
                        <button id="btnYes${divisor}" class="quiz-option" data-answer="true">YES</button>
                        <button id="btnNo${divisor}" class="quiz-option" data-answer="false">NO</button>
                    </div>
                </div>
            `;

          quizOptionsContainer.appendChild(optionDiv);

          // Asignar listeners despu√©s de adjuntar al DOM
          const btnYes = document.getElementById(`btnYes${divisor}`);
          const btnNo = document.getElementById(`btnNo${divisor}`);

          // Usamos bind para pasar los par√°metros correctos al selectAnswer
          btnYes.onclick = selectAnswer.bind(
            null,
            divisor,
            true,
            btnYes,
            btnNo
          );
          btnNo.onclick = selectAnswer.bind(
            null,
            divisor,
            false,
            btnYes,
            btnNo
          );
        });
      }

      // --- Inicializaci√≥n ---
      window.onload = () => {
        generateNewNumber();
      };
    </script>
  </body>
</html>
