<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Fraction Addition & Subtraction Practice</title>
    <link rel="stylesheet" href="../shared-styles.css" />
    <style>
      /* Additional styles specific to fractions challenge */
      .fraction-display {
        display: inline-flex;
        flex-direction: column;
        align-items: center;
        justify-content: center;
        line-height: 1;
      }
      .fraction-bar {
        border-bottom: 3px solid currentColor;
        width: 100%;
        margin: 0.25rem 0;
      }
      .numerator,
      .denominator {
        padding: 0 0.5rem;
        font-size: 2.5rem;
        font-weight: 700;
      }

      .operator-display {
        font-family: var(--font-heading);
        font-size: 3rem;
        font-weight: 700;
        padding: 0 1rem;
        color: var(--color-math-blue);
      }

      .input-group {
        display: flex;
        align-items: center;
        gap: 1rem;
        justify-content: center;
        margin-top: 1.5rem;
      }

      .input-field {
        padding: 0.75rem 1rem;
        border: 2px solid var(--border-color);
        border-radius: 12px;
        font-family: var(--font-body);
        font-size: 1.1rem;
        transition: all 0.2s ease;
        width: 120px;
        text-align: center;
      }

      .input-field:focus {
        outline: none;
        border-color: var(--color-math-blue);
        box-shadow: 0 0 0 3px rgba(30, 144, 255, 0.1);
      }

      .feedback-item {
        border-radius: 15px;
        padding: 1.5rem;
        margin-top: 1.5rem;
        border-left: 5px solid;
        font-family: var(--font-body);
        animation: slideIn 0.3s ease;
      }

      @keyframes slideIn {
        from {
          opacity: 0;
          transform: translateX(-10px);
        }
        to {
          opacity: 1;
          transform: translateX(0);
        }
      }

      .feedback-correct {
        background: var(--bg-light-green);
        border-color: var(--color-math-green);
        color: #1b5e20;
      }

      .feedback-incorrect {
        background: #ffebee;
        border-color: var(--color-math-pink);
        color: #b71c1c;
      }

      .feedback-failed {
        background: var(--bg-light-orange);
        border-color: var(--color-math-orange);
        color: #e65100;
      }

      .progress-info {
        font-family: var(--font-handwriting);
        font-size: 1.2rem;
        color: var(--text-secondary);
        display: flex;
        justify-content: space-between;
        margin-bottom: 0.75rem;
      }
    </style>
  </head>
  <body>
    <!-- Back to Home Button -->
    <a href="../index.html" class="btn-back-home"> Home Menu </a>

    <!-- Decorative Doodles -->
    <div class="doodle doodle-1">‚ûï</div>
    <div class="doodle doodle-2">‚ûñ</div>
    <div class="doodle doodle-3">üî¢</div>
    <div class="doodle doodle-4">üìö</div>

    <div class="container">
      <!-- Header -->
      <header class="header">
        <h1>FRACTION ADDITION & SUBTRACTION</h1>
        <p class="subtitle">Master adding and subtracting fractions with confidence!</p>
      </header>

      <!-- Main Card -->
      <div class="card">
        <!-- Progress Bar -->
        <div class="progress-container">
          <div class="progress-info">
            <span>Problem <span id="currentProblemDisplay">1</span> of 20</span>
            <span id="scoreDisplay">Score: 0/0</span>
          </div>
          <div class="progress-bar">
            <div id="progressBar" class="progress-fill" style="width: 0%"></div>
          </div>
        </div>

        <!-- Problem Display -->
        <div class="problem-box">
          <div
            id="problemDisplay"
            style="
              display: flex;
              align-items: center;
              justify-content: center;
              flex-wrap: wrap;
              gap: 0.5rem;
              min-height: 120px;
            "
          >
            <p
              class="handwriting"
              style="color: var(--text-secondary); font-size: 1.2rem"
            >
              Loading problem...
            </p>
          </div>
        </div>

        <!-- Input Area -->
        <div style="margin-top: 2rem">
          <p class="handwriting" style="font-size: 1.5rem; color: var(--text-primary); text-align: center; margin-bottom: 1rem">
            Your Answer:
          </p>

          <div class="input-group">
            <input
              type="number"
              id="inputNum"
              placeholder="Numerator"
              class="input-field"
            />
            <span style="font-size: 2rem; color: var(--text-primary);">‚îÄ</span>
            <input
              type="number"
              id="inputDen"
              placeholder="Denominator"
              class="input-field"
            />
          </div>

          <div style="display: flex; gap: 1rem; margin-top: 2rem; justify-content: center;">
            <button
              onclick="checkAnswer()"
              id="checkButton"
              class="btn btn-primary"
              style="flex: 1; max-width: 300px"
            >
              ‚úì Check Answer
            </button>
          </div>
        </div>

        <!-- Feedback Area -->
        <div id="feedbackArea" class="hidden" style="margin-top: 2rem">
          <!-- Feedback message goes here -->
        </div>
      </div>
    </div>

    <script>
      // --- Configuration ---
      const TOTAL_PROBLEMS = 20;
      const MAX_ATTEMPTS = 3;
      const DENOMINATORS = [2, 3, 4, 5, 6, 8, 10, 12];
      const MAX_DENOM_VALUE = 12;

      // --- State ---
      let state = {
        currentProblemIndex: 0,
        correctlySolved: 0,
        currentProblem: null,
        attemptCounters: 0,
      };

      // --- Helper Functions (Math Logic) ---

      const gcd = (a, b) => (b === 0 ? a : gcd(b, a % b));
      const lcm = (a, b) => (a * b) / gcd(a, b);
      const arrayLcm = (arr) => arr.reduce((acc, val) => lcm(acc, val), 1);

      function simplifyFraction(num, den) {
        if (num === 0) return { num: 0, den: 1 };
        if (den === 0) return { num: 0, den: 0 };

        const sign = (num < 0 && den < 0) || (num > 0 && den < 0) ? -1 : 1;
        num = Math.abs(num);
        den = Math.abs(den);

        const commonDivisor = gcd(num, den);
        return {
          num: sign * (num / commonDivisor),
          den: den / commonDivisor,
        };
      }

      // --- Problem Generation Logic ---

      function generateSingleFraction(maxDenom) {
        const den = DENOMINATORS[Math.floor(Math.random() * DENOMINATORS.length)];
        let num = Math.floor(Math.random() * (den * 2)) + 1;
        if (Math.random() < 0.2) {
          num = 1;
        }
        return { num, den };
      }

      function generateProblem() {
        const numFractions = Math.floor(Math.random() * 3) + 2;
        let fractions = [];

        let f1, f2, op2;
        let firstSubtractionIsNegative = true;
        let attempts = 0;
        const MAX_REGEN_ATTEMPTS = 50;

        do {
          f1 = generateSingleFraction(MAX_DENOM_VALUE);
          f1.op = "+";

          f2 = generateSingleFraction(MAX_DENOM_VALUE);
          op2 = Math.random() < 0.75 ? "+" : "-";
          f2.op = op2;

          if (op2 === "-") {
            if (f1.num * f2.den >= f2.num * f1.den) {
              firstSubtractionIsNegative = false;
            } else {
              firstSubtractionIsNegative = true;
            }
          } else {
            firstSubtractionIsNegative = false;
          }

          attempts++;
          if (attempts > MAX_REGEN_ATTEMPTS) {
            f1.num = f1.den * 2;
            firstSubtractionIsNegative = false;
          }
        } while (firstSubtractionIsNegative);

        fractions.push(f1, f2);

        for (let i = 2; i < numFractions; i++) {
          const fraction = generateSingleFraction(MAX_DENOM_VALUE);
          fraction.op = Math.random() < 0.75 ? "+" : "-";
          fractions.push(fraction);
        }

        return fractions;
      }

      function calculateAnswer(fractions) {
        const denominators = fractions.map((f) => f.den);
        const commonDenom = arrayLcm(denominators);

        let finalNumerator = 0;

        fractions.forEach((f) => {
          const termNumerator = f.num * (commonDenom / f.den);
          if (f.op === "+") {
            finalNumerator += termNumerator;
          } else if (f.op === "-") {
            finalNumerator -= termNumerator;
          }
        });

        return simplifyFraction(finalNumerator, commonDenom);
      }

      // --- Rendering Functions ---

      function renderProblem(fractions) {
        const problemDisplay = document.getElementById("problemDisplay");
        problemDisplay.innerHTML = "";

        fractions.forEach((f, index) => {
          if (index > 0) {
            const opSpan = document.createElement("span");
            opSpan.className = "operator-display";
            opSpan.textContent = f.op;
            problemDisplay.appendChild(opSpan);
          }

          const fractionDiv = document.createElement("div");
          fractionDiv.className = "fraction-display";
          fractionDiv.style.color = "var(--color-math-blue)";
          fractionDiv.innerHTML = `
            <span class="numerator">${f.num}</span>
            <span class="fraction-bar"></span>
            <span class="denominator">${f.den}</span>
          `;
          problemDisplay.appendChild(fractionDiv);
        });

        const eqSpan = document.createElement("span");
        eqSpan.className = "operator-display";
        eqSpan.textContent = "=";
        problemDisplay.appendChild(eqSpan);
      }

      function nextProblem() {
        if (state.currentProblemIndex >= TOTAL_PROBLEMS) {
          document.getElementById("problemDisplay").innerHTML = `
            <p style="font-size: 2rem; font-weight: 700; color: var(--color-math-green);">Exercise Complete!</p>
            <p style="font-size: 1.2rem; color: var(--text-secondary); margin-top: 1rem;">Final Score: ${state.correctlySolved} out of ${TOTAL_PROBLEMS}</p>
          `;
          document.getElementById("checkButton").disabled = true;
          document.getElementById("inputNum").disabled = true;
          document.getElementById("inputDen").disabled = true;
          return;
        }

        state.attemptCounters = 0;

        document.getElementById("inputNum").value = "";
        document.getElementById("inputDen").value = "";
        document.getElementById("checkButton").disabled = false;
        document.getElementById("inputNum").disabled = false;
        document.getElementById("inputDen").disabled = false;
        document.getElementById("feedbackArea").classList.add("hidden");

        let fractions;
        let answer;
        let resultIsNegative = false;
        let attempts = 0;
        const MAX_GENERATION_ATTEMPTS = 100;

        do {
          fractions = generateProblem();
          answer = calculateAnswer(fractions);
          resultIsNegative = answer.num < 0;
          attempts++;

          if (attempts > MAX_GENERATION_ATTEMPTS) {
            answer.num = 0;
            answer.den = 1;
            resultIsNegative = false;
          }
        } while (resultIsNegative);

        state.currentProblem = { fractions, answer };
        renderProblem(fractions);

        document.getElementById("currentProblemDisplay").textContent =
          state.currentProblemIndex + 1;
        updateProgress();
      }

      function updateProgress() {
        const progress = (state.currentProblemIndex / TOTAL_PROBLEMS) * 100;
        document.getElementById("progressBar").style.width = `${progress}%`;
        document.getElementById("scoreDisplay").textContent = 
          `Score: ${state.correctlySolved}/${state.currentProblemIndex}`;
      }

      // --- Interaction Functions ---

      function checkAnswer() {
        const inputNum = document.getElementById("inputNum");
        const inputDen = document.getElementById("inputDen");
        const feedbackArea = document.getElementById("feedbackArea");
        const checkButton = document.getElementById("checkButton");

        const userAnswerNum = parseInt(inputNum.value.trim(), 10);
        const userAnswerDen = parseInt(inputDen.value.trim(), 10);

        if (isNaN(userAnswerNum) || isNaN(userAnswerDen) || userAnswerDen === 0) {
          feedbackArea.textContent =
            "Please enter valid, non-zero numbers for the numerator and denominator.";
          feedbackArea.className = "feedback-item feedback-incorrect";
          feedbackArea.classList.remove("hidden");
          return;
        }

        const correct = state.currentProblem.answer;
        const userSimplified = simplifyFraction(userAnswerNum, userAnswerDen);

        const isCorrect =
          userSimplified.num === correct.num &&
          userSimplified.den === correct.den;

        if (isCorrect) {
          state.correctlySolved++;
          state.currentProblemIndex++;

          feedbackArea.innerHTML =
            "<strong>Correct! ‚úÖ</strong> Well done! Moving to the next problem in 2 seconds...";
          feedbackArea.className = "feedback-item feedback-correct";
          feedbackArea.classList.remove("hidden");

          inputNum.disabled = true;
          inputDen.disabled = true;
          checkButton.disabled = true;

          setTimeout(nextProblem, 2000);
        } else {
          state.attemptCounters++;
          const attemptsLeft = MAX_ATTEMPTS - state.attemptCounters;

          if (attemptsLeft > 0) {
            feedbackArea.innerHTML = `<strong>Incorrect. ‚ùå</strong> Please try again. Attempts remaining: ${attemptsLeft}.`;
            feedbackArea.className = "feedback-item feedback-incorrect";
          } else {
            state.currentProblemIndex++;

            feedbackArea.innerHTML = `
              <strong>Maximum attempts reached.</strong> The simplified answer is: 
              <span style="font-size: 1.5rem; font-weight: 700; color: var(--color-math-orange);">${correct.num} / ${correct.den}</span>.
              Moving to the next problem in 5 seconds... üò•
            `;
            feedbackArea.className = "feedback-item feedback-failed";

            inputNum.disabled = true;
            inputDen.disabled = true;
            checkButton.disabled = true;

            setTimeout(nextProblem, 5000);
          }
          feedbackArea.classList.remove("hidden");
        }
      }

      // --- Initialization ---
      window.onload = function () {
        nextProblem();
      };
    </script>
  </body>
</html>
